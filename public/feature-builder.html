
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature Builder | Rickovery by Thistleseeds</title>
  <meta name="description" content="Build your custom Rickovery feature package. Interactive tool to select the capabilities that fit your program's needs.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', Arial, sans-serif; background: #f8f9fa; min-height: 100vh; }
    
    :root {
      --teal: #1a3a4a;
      --teal-light: #2a5a6a;
      --gold: #d4a84b;
      --gold-light: #f5e6c8;
      --gray-light: #f8f9fa;
      --gray: #6c757d;
    }
    
    /* Navigation */
    nav {
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      color: white;
      font-size: 22px;
      font-weight: 700;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo span { color: var(--gold); }
    nav ul {
      display: flex;
      list-style: none;
      gap: 32px;
    }
    nav a {
      color: var(--teal);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.2s;
    }
    nav a:hover { color: var(--gold); }
    
    .header { background: var(--teal); color: white; padding: 20px 24px; }
    .header h1 { font-size: 24px; font-weight: bold; margin-bottom: 8px; }
    .header p { opacity: 0.9; font-size: 14px; }
    
    .summary-bar { background: var(--gold); color: var(--teal); padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .summary-bar .stats { display: flex; gap: 24px; flex-wrap: wrap; }
    .summary-bar button { background: var(--teal); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .summary-bar button:hover { background: var(--teal-light); }
    
    .legend { background: white; padding: 12px 24px; border-bottom: 1px solid #e0e0e0; display: flex; gap: 16px; flex-wrap: wrap; align-items: center; }
    .legend-label { font-size: 13px; color: #666; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-swatch { width: 12px; height: 12px; border-radius: 2px; border-width: 2px; border-style: solid; }
    .legend-item span { font-size: 12px; color: #555; }
    .legend-note { margin-left: auto; font-size: 12px; color: #888; }
    
    .main-container { display: flex; }
    .workflow-area { flex: 1; background: white; padding: 24px; overflow-x: auto; }
    
    .phase { margin-bottom: 24px; }
    .phase-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .phase-badge { background: var(--teal); color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .phase-name { font-size: 14px; color: #666; }
    .phase-line { flex: 1; height: 1px; background: #e0e0e0; }
    
    .features-grid { display: flex; flex-wrap: wrap; gap: 12px; margin-left: 8px; }
    
    .feature-card {
      background: #fafafa;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 12px 16px;
      cursor: pointer;
      min-width: 180px;
      max-width: 220px;
      position: relative;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .feature-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .feature-card.disabled { opacity: 0.5; cursor: not-allowed; }
    .feature-card .check { position: absolute; top: -8px; right: -8px; background: #2e7d32; color: white; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 12px; }
    .feature-card.selected .check { display: flex; }
    .feature-card .title { font-size: 13px; font-weight: bold; color: #555; margin-bottom: 4px; }
    .feature-card.selected .title { color: inherit; }
    .feature-card .weeks { font-size: 11px; color: #888; }
    .feature-card .prereqs { font-size: 10px; color: #aaa; margin-top: 4px; }
    
    .details-panel { width: 320px; background: #f5f5f5; border-left: 1px solid #e0e0e0; padding: 20px; min-height: 500px; }
    .details-panel.hidden { display: none; }
    .details-placeholder { color: #888; text-align: center; padding-top: 40px; }
    .details-placeholder .icon { font-size: 40px; margin-bottom: 12px; }
    
    .details-content { display: none; }
    .details-content.active { display: block; }
    .details-category { font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 4px; }
    .details-title { margin: 0 0 12px 0; color: var(--teal); font-size: 18px; }
    .details-weeks { background: var(--gold); color: var(--teal); padding: 8px 12px; border-radius: 4px; margin-bottom: 16px; font-size: 13px; }
    .details-desc { font-size: 14px; color: #444; line-height: 1.5; margin-bottom: 16px; }
    .details-value { background: #e8f5e9; padding: 12px; border-radius: 4px; border-left: 3px solid #2e7d32; margin-bottom: 16px; }
    .details-value-label { font-size: 11px; color: #2e7d32; font-weight: bold; margin-bottom: 4px; }
    .details-value-text { font-size: 13px; color: #1b5e20; }
    .details-prereqs-label { font-size: 11px; color: #888; margin-bottom: 8px; }
    .details-prereq-item { font-size: 12px; color: #555; padding: 4px 0; }
    
    .selection-summary { background: white; border-top: 1px solid #e0e0e0; padding: 20px 24px; }
    .selection-summary h3 { margin: 0 0 12px 0; color: var(--teal); font-size: 16px; }
    .selection-summary .empty { color: #888; }
    .selection-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
    .selection-tag { padding: 4px 10px; border-radius: 16px; font-size: 12px; border-width: 1px; border-style: solid; }
    
    /* Category colors */
    .cat-core { --bg: #e8f4f8; --border: #1a3a4a; --text: #1a3a4a; }
    .cat-reward { --bg: #fef6e6; --border: #d4a84b; --text: #8b6914; }
    .cat-sentiment { --bg: #f0e8f5; --border: #7c5295; --text: #5a3d6e; }
    .cat-analytics { --bg: #e8f5e9; --border: #2e7d32; --text: #1b5e20; }
    .cat-llm { --bg: #e3f2fd; --border: #1565c0; --text: #0d47a1; }
    .cat-postgrad { --bg: #fce4ec; --border: #c2185b; --text: #880e4f; }
    .cat-premium { --bg: #fff3e0; --border: #e65100; --text: #bf360c; }
    
    .feature-card.selected { background: var(--bg); border-color: var(--border); }
    .feature-card.selected .title { color: var(--text); }
    .selection-tag { background: var(--bg); border-color: var(--border); color: var(--text); }
    
    /* Quote Form */
    .quote-form {
      background: var(--teal);
      padding: 40px 24px;
      color: white;
    }
    .quote-form-inner {
      max-width: 600px;
      margin: 0 auto;
    }
    .quote-form h2 {
      font-size: 28px;
      margin-bottom: 8px;
      text-align: center;
    }
    .quote-form > p {
      text-align: center;
      opacity: 0.9;
      margin-bottom: 32px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group.full { grid-column: 1 / -1; }
    .form-group label {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
    }
    .form-group input, .form-group textarea, .form-group select {
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .form-group input::placeholder, .form-group textarea::placeholder {
      color: rgba(255,255,255,0.5);
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(255,255,255,0.15);
    }
    .form-group select option { color: #333; }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .hidden-field { display: none; }
    .submit-btn {
      display: block;
      width: 100%;
      background: var(--gold);
      color: var(--teal);
      border: none;
      padding: 16px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .form-note {
      text-align: center;
      font-size: 12px;
      opacity: 0.7;
      margin-top: 16px;
    }
    
    /* Success message */
    .success-message {
      display: none;
      text-align: center;
      padding: 40px;
    }
    .success-message.show { display: block; }
    .success-message .icon { font-size: 60px; margin-bottom: 16px; }
    .success-message h3 { font-size: 24px; margin-bottom: 12px; }
    .success-message p { opacity: 0.9; }
    
    /* Footer */
    footer {
      background: #1a3a4a;
      color: white;
      padding: 30px 24px;
      text-align: center;
    }
    footer a { color: var(--gold); }
    
    @media (max-width: 900px) {
      .main-container { flex-direction: column; }
      .details-panel { width: 100%; min-height: auto; }
      nav ul { display: none; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html" class="logo"><img src="/logo.png" alt="Thistleseeds" style="height: 50px;"></a>
    <ul>
      <li><a href="index.html">‚Üê Back to Home</a></li>
    </ul>
  </nav>

  <div class="header">
    <h1>Rickovery Feature Builder</h1>
    <p>Click features to select. Prerequisites auto-add. Hover for details.</p>
  </div>
  
  <div class="summary-bar">
    <div class="stats">
      <span><strong id="feature-count">3</strong> features selected</span>
      <span><strong>~<span id="total-weeks">8</span></strong> weeks to full deployment</span>
    </div>
    <button id="toggle-panel">Hide Details Panel</button>
  </div>
  
  <div class="legend">
    <span class="legend-label">Categories:</span>
    <div class="legend-item"><div class="legend-swatch" style="background:#e8f4f8;border-color:#1a3a4a"></div><span>Core App</span></div>
    <div class="legend-item"><div class="legend-swatch" style="background:#fef6e6;border-color:#d4a84b"></div><span>Rewards</span></div>
    <div class="legend-item"><div class="legend-swatch" style="background:#f0e8f5;border-color:#7c5295"></div><span>Sentiment</span></div>
    <div class="legend-item"><div class="legend-swatch" style="background:#e8f5e9;border-color:#2e7d32"></div><span>Analytics</span></div>
    <div class="legend-item"><div class="legend-swatch" style="background:#e3f2fd;border-color:#1565c0"></div><span>AI/LLM</span></div>
    <div class="legend-item"><div class="legend-swatch" style="background:#fce4ec;border-color:#c2185b"></div><span>Post-Grad</span></div>
    <div class="legend-item"><div class="legend-swatch" style="background:#fff3e0;border-color:#e65100"></div><span>Premium</span></div>
    <span class="legend-note">‚òÖ = Key evidence/compliance feature</span>
  </div>
  
  <div class="main-container">
    <div class="workflow-area" id="workflow-area"></div>
    <div class="details-panel" id="details-panel">
      <div class="details-placeholder" id="details-placeholder">
        <div class="icon">üëÜ</div>
        <p>Hover over a feature to see details</p>
      </div>
      <div class="details-content" id="details-content">
        <div class="details-category" id="detail-category"></div>
        <h3 class="details-title" id="detail-title"></h3>
        <div class="details-weeks"><strong id="detail-weeks"></strong> weeks</div>
        <p class="details-desc" id="detail-desc"></p>
        <div class="details-value">
          <div class="details-value-label">VALUE</div>
          <div class="details-value-text" id="detail-value"></div>
        </div>
        <div id="detail-prereqs-section">
          <div class="details-prereqs-label">PREREQUISITES</div>
          <div id="detail-prereqs"></div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="selection-summary">
    <h3>Your Selection</h3>
    <div id="selection-tags"></div>
  </div>

  <div class="quote-form">
    <div class="quote-form-inner">
      <h2>Request a Quote</h2>
      <p>Submit your feature selections and we'll get back to you with pricing and timeline.</p>
      
      <!-- Netlify Forms - the form will automatically be detected -->
      <form id="quote-form" name="feature-request" method="POST" data-netlify="true" netlify-honeypot="bot-field">
        <input type="hidden" name="form-name" value="feature-request">
        <p class="hidden-field">
          <label>Don't fill this out: <input name="bot-field"></label>
        </p>
        
        <div class="form-row">
          <div class="form-group">
            <label for="name">Your Name *</label>
            <input type="text" id="name" name="name" required placeholder="Jane Smith">
          </div>
          <div class="form-group">
            <label for="email">Email *</label>
            <input type="email" id="email" name="email" required placeholder="jane@facility.org">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="organization">Organization *</label>
            <input type="text" id="organization" name="organization" required placeholder="Recovery Center Name">
          </div>
          <div class="form-group">
            <label for="phone">Phone</label>
            <input type="tel" id="phone" name="phone" placeholder="(555) 123-4567">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="patient-count">Approximate Patient Count</label>
            <select id="patient-count" name="patient-count">
              <option value="">Select range...</option>
              <option value="1-25">1-25 patients</option>
              <option value="26-50">26-50 patients</option>
              <option value="51-100">51-100 patients</option>
              <option value="100+">100+ patients</option>
            </select>
          </div>
          <div class="form-group">
            <label for="timeline">Desired Timeline</label>
            <select id="timeline" name="timeline">
              <option value="">Select timeline...</option>
              <option value="asap">As soon as possible</option>
              <option value="1-3months">1-3 months</option>
              <option value="3-6months">3-6 months</option>
              <option value="exploring">Just exploring</option>
            </select>
          </div>
        </div>
        
        <div class="form-group full">
          <label for="notes">Additional Notes</label>
          <textarea id="notes" name="notes" placeholder="Tell us about your program, specific needs, or any questions..."></textarea>
        </div>
        
        <!-- Hidden field for selected features -->
        <input type="hidden" id="selected-features" name="selected-features">
        <input type="hidden" id="feature-count-hidden" name="feature-count">
        <input type="hidden" id="total-weeks-hidden" name="total-weeks">
        
        <button type="submit" class="submit-btn">Submit Quote Request</button>
        <p class="form-note">We'll respond within 1-2 business days.</p>
      </form>
      
      <div class="success-message" id="success-message">
        <div class="icon">‚úÖ</div>
        <h3>Request Submitted!</h3>
        <p>Thank you for your interest in Rickovery. We'll review your feature selections and get back to you within 1-2 business days.</p>
      </div>
    </div>
  </div>

  <footer>
    <p>¬© 2025 <a href="index.html"><img src="/logo.png" alt="Thistleseeds" style="height: 24px; vertical-align: middle;"></a>. All rights reserved.</p>
  </footer>

  <script>
    // FIXED: Now using incremental weeks (how long each feature takes to build)
    // instead of cumulative weeks. Total is calculated by summing selected features.
    const features = {
      // Phase 0 - No prerequisites (can start immediately)
      'crisis': { name: 'One-Click Crisis Support', weeks: 2, prereqs: [], category: 'core', phase: 0,
        description: 'Always-on-top crisis support button with immediate connection to your chosen hotline or response protocol. Therapeutic UI with warm, supportive colors.',
        value: 'Patient safety foundation - required for any deployment' },
      'morning': { name: 'Morning Ritual', weeks: 3, prereqs: [], category: 'core', phase: 0,
        description: 'Daily quote/thought of the day plus photo verification of clean bed and sink. AI analysis confirms cleanliness standards.',
        value: 'Daily engagement touchpoint, builds routine compliance' },
      'schedule': { name: 'Patient Schedule Manager', weeks: 3, prereqs: [], category: 'core', phase: 0,
        description: 'Patients set, confirm, move, and cancel appointments. Accessible UI designed for high success and low frustration.',
        value: 'Core enabler - most features depend on this' },
      
      // Phase 1 - Requires Patient Schedule
      'staff': { name: 'Staff Schedule Management', weeks: 3, prereqs: ['schedule'], category: 'core', phase: 1,
        description: 'Central dashboard to monitor and modify all patient schedules. Automated notifications for late/no-show. Daily, weekly, monthly reports.',
        value: 'Operational visibility for clinical staff' },
      'biometric': { name: 'Biometric Verification', weeks: 6, prereqs: ['schedule'], category: 'core', phase: 1,
        description: 'Anti-bot analysis of gesture patterns, AI ensures every selfie is unique. Cryptographically stored for legal evidence chain.',
        value: '‚òÖ Combats device-farm fraud at scale' },
      
      // Phase 2 - Requires Staff Management
      'attendance': { name: 'Attendance Verification', weeks: 4, prereqs: ['staff'], category: 'core', phase: 2,
        description: 'Geofencing verifies presence. Patient selfie at session start. Cryptographic evidence chain for audits. Manual commenting for device failures.',
        value: '‚òÖ Key feature for service delivery evidence' },
      'buddy': { name: 'Buddy System', weeks: 3, prereqs: ['staff'], category: 'core', phase: 2,
        description: 'Staff assign buddy groups for peer accountability. Patients invite buddies to events. Group notifications for late/no-shows.',
        value: 'Peer support network, improves retention' },
      'coins': { name: 'Rickovery Coins', weeks: 4, prereqs: ['staff'], category: 'reward', phase: 2,
        description: 'Patients earn coins for attending appointments. Staff can award bonus coins. Coins accumulate toward real-world rewards.',
        value: 'Gamification foundation for engagement' },
      'anon': { name: 'Anonymized Data & Reporting', weeks: 3, prereqs: ['staff'], category: 'analytics', phase: 2,
        description: 'Extract publicly usable data from HIPAA-secure records. Formatted for reports, grant proposals, presentations.',
        value: '‚òÖ Core feature for demonstrating program effectiveness' },
      'chat': { name: 'AI-Enabled Chat', weeks: 8, prereqs: ['staff'], category: 'llm', phase: 2,
        description: 'Schedule appointments via natural text conversation. 24/7 AI sober buddy support. English with optional Spanish.',
        value: 'Reduces staff burden, 24/7 patient support' },
      
      // Phase 3 - Various prerequisites
      'treasure': { name: 'Treasure Trove', weeks: 6, prereqs: ['coins'], category: 'reward', phase: 3,
        description: 'Spend coins on app customization: icons, themes, sobriety-friendly media. Automated savings with staff-set minimum rate.',
        value: 'In-app rewards increase daily engagement' },
      'buddyrewards': { name: 'Buddy Group Rewards', weeks: 4, prereqs: ['coins'], category: 'reward', phase: 3,
        description: 'Groups earn collective coins for attendance rates and project completion. In-app group branding and recognition.',
        value: 'Team incentives improve group accountability' },
      'usage': { name: 'App Usage Analysis', weeks: 5, prereqs: ['buddy'], category: 'sentiment', phase: 3,
        description: 'Detects concerning patterns like late-night usage, frequency changes, engagement trends. Tracks current status and direction of change.',
        value: 'Early warning system for intervention timing' },
      'behavior': { name: 'Behavior Pattern Analysis', weeks: 5, prereqs: ['attendance'], category: 'sentiment', phase: 3,
        description: 'Recognizes schedule patterns (show/no-show trends) and buddy system patterns (participation vs avoidance).',
        value: '‚òÖ Critical data for outcome tracking' },
      'bi': { name: 'LLM Business Intelligence', weeks: 6, prereqs: ['anon'], category: 'analytics', phase: 3,
        description: 'Natural language queries for custom charts and reports. AI search and analysis keeps proprietary data private.',
        value: 'No-code reporting for non-technical staff' },
      'voice': { name: 'Voice Chat', weeks: 6, prereqs: ['chat'], category: 'llm', phase: 3,
        description: 'Speak instead of type. Voice-and-text responses. HIPAA/42 CFR Part 2 compliant voice storage. English + Spanish.',
        value: 'Accessibility for patients who struggle with typing' },
      
      // Phase 4 - Advanced features
      'aisentiment': { name: 'AI Sentiment Analysis', weeks: 4, prereqs: ['usage', 'behavior'], category: 'llm', phase: 4,
        description: 'Advanced detection of suicidal ideation and relapse language. Analysis of enthusiasm, self-doubt, engagement, boredom.',
        value: '‚òÖ Critical for early intervention on relapse risk' },
      'postgrad': { name: 'Post-Graduation Infrastructure', weeks: 6, prereqs: ['usage', 'behavior'], category: 'postgrad', phase: 4,
        description: 'Alumni membership pool, volunteer/paid peer support staff. More patient control over settings. Relapse risk focus.',
        value: '‚òÖ Proves long-term program effectiveness' },
      'wristband': { name: 'Wristband Integration', weeks: 8, prereqs: ['usage', 'behavior'], category: 'premium', phase: 4,
        description: 'Combined wearable + phone verification for maximum accuracy. Blood pressure, heart rate, respiration, sleep monitoring.',
        value: '‚òÖ Highest tier of service delivery verification' },
      
      // Phase 5 - Post-graduation
      'expanded': { name: 'Expanded Reward System', weeks: 10, prereqs: ['postgrad'], category: 'postgrad', phase: 5,
        description: 'Celebrity videos, donated trips, partnerships with trade schools and community colleges.',
        value: 'Alumni network sustainability' },
    };

    const categoryNames = {
      core: 'Core App', reward: 'Rewards', sentiment: 'Sentiment',
      analytics: 'Analytics', llm: 'AI/LLM', postgrad: 'Post-Grad', premium: 'Premium'
    };
    const phaseNames = ['Foundation', 'Operations', 'Evidence', 'Intelligence', 'Outcomes', 'Alumni'];

    let selected = new Set(['crisis', 'schedule', 'morning']);
    let panelVisible = true;

    function canSelect(id) {
      return features[id].prereqs.every(p => selected.has(p));
    }

    function toggleFeature(id) {
      if (selected.has(id)) {
        const toRemove = [id];
        let changed = true;
        while (changed) {
          changed = false;
          Object.entries(features).forEach(([fid, f]) => {
            if (selected.has(fid) && f.prereqs.some(p => toRemove.includes(p)) && !toRemove.includes(fid)) {
              toRemove.push(fid);
              changed = true;
            }
          });
        }
        toRemove.forEach(r => selected.delete(r));
      } else {
        if (!canSelect(id)) return;
        const toAdd = [id];
        let changed = true;
        while (changed) {
          changed = false;
          toAdd.forEach(aid => {
            features[aid].prereqs.forEach(p => {
              if (!toAdd.includes(p)) { toAdd.push(p); changed = true; }
            });
          });
        }
        toAdd.forEach(a => selected.add(a));
      }
      render();
      updateHiddenFields();
    }

    function showDetails(id) {
      const f = features[id];
      document.getElementById('details-placeholder').style.display = 'none';
      document.getElementById('details-content').classList.add('active');
      document.getElementById('detail-category').textContent = categoryNames[f.category];
      document.getElementById('detail-title').textContent = f.name;
      document.getElementById('detail-weeks').textContent = f.weeks;
      document.getElementById('detail-desc').textContent = f.description;
      document.getElementById('detail-value').textContent = f.value;
      
      const prereqsSection = document.getElementById('detail-prereqs-section');
      const prereqsContainer = document.getElementById('detail-prereqs');
      if (f.prereqs.length > 0) {
        prereqsSection.style.display = 'block';
        prereqsContainer.innerHTML = f.prereqs.map(p => 
          `<div class="details-prereq-item">‚Üí ${features[p].name}</div>`
        ).join('');
      } else {
        prereqsSection.style.display = 'none';
      }
    }

    function hideDetails() {
      document.getElementById('details-placeholder').style.display = 'block';
      document.getElementById('details-content').classList.remove('active');
    }

    // FIXED: Calculate total weeks by summing all selected features
    function calculateTotalWeeks() {
      if (selected.size === 0) return 0;
      let total = 0;
      selected.forEach(id => {
        total += features[id].weeks;
      });
      return total;
    }

    function updateHiddenFields() {
      const selectedList = Array.from(selected).map(id => features[id].name).join(', ');
      const totalWeeks = calculateTotalWeeks();
      
      document.getElementById('selected-features').value = selectedList;
      document.getElementById('feature-count-hidden').value = selected.size;
      document.getElementById('total-weeks-hidden').value = totalWeeks;
    }

    function render() {
      const area = document.getElementById('workflow-area');
      area.innerHTML = '';

      const phases = [0, 1, 2, 3, 4, 5];
      phases.forEach(phase => {
        const phaseFeatures = Object.entries(features).filter(([_, f]) => f.phase === phase);
        if (phaseFeatures.length === 0) return;

        const phaseDiv = document.createElement('div');
        phaseDiv.className = 'phase';
        
        phaseDiv.innerHTML = `
          <div class="phase-header">
            <div class="phase-badge">Phase ${phase}</div>
            <span class="phase-name">${phaseNames[phase]}</span>
            ${phase > 0 ? '<div class="phase-line"></div>' : ''}
          </div>
          <div class="features-grid"></div>
        `;
        
        const grid = phaseDiv.querySelector('.features-grid');
        phaseFeatures.forEach(([id, f]) => {
          const isSelected = selected.has(id);
          const isAvailable = canSelect(id);
          
          const card = document.createElement('div');
          card.className = `feature-card cat-${f.category}${isSelected ? ' selected' : ''}${!isAvailable && !isSelected ? ' disabled' : ''}`;
          card.innerHTML = `
            <div class="check">‚úì</div>
            <div class="title">${f.name}</div>
            <div class="weeks">${f.weeks} weeks</div>
            ${f.prereqs.length > 0 ? `<div class="prereqs">Requires: ${f.prereqs.map(p => features[p].name.split(' ')[0]).join(', ')}</div>` : ''}
          `;
          card.addEventListener('click', () => toggleFeature(id));
          card.addEventListener('mouseenter', () => showDetails(id));
          card.addEventListener('mouseleave', hideDetails);
          grid.appendChild(card);
        });
        
        area.appendChild(phaseDiv);
      });

      // Update summary - FIXED: now sums weeks
      document.getElementById('feature-count').textContent = selected.size;
      document.getElementById('total-weeks').textContent = calculateTotalWeeks();

      // Update selection tags
      const tagsContainer = document.getElementById('selection-tags');
      if (selected.size === 0) {
        tagsContainer.innerHTML = '<p class="empty">No features selected. Click features above to build your package.</p>';
      } else {
        const sorted = Array.from(selected).sort((a, b) => features[a].phase - features[b].phase);
        tagsContainer.innerHTML = sorted.map(id => 
          `<span class="selection-tag cat-${features[id].category}">${features[id].name}</span>`
        ).join('');
      }
    }

    document.getElementById('toggle-panel').addEventListener('click', function() {
      panelVisible = !panelVisible;
      document.getElementById('details-panel').classList.toggle('hidden', !panelVisible);
      this.textContent = panelVisible ? 'Hide Details Panel' : 'Show Details Panel';
    });

    // Form submission handling
    document.getElementById('quote-form').addEventListener('submit', function(e) {
      updateHiddenFields();
      
      // For Netlify, we let the form submit normally
      // But show success message after a brief delay
      setTimeout(() => {
        document.getElementById('quote-form').style.display = 'none';
        document.getElementById('success-message').classList.add('show');
      }, 100);
    });

    render();
    updateHiddenFields();
  </script>
</body>
</html>
